#$ -cwd
#$ -q high_mem
#$ -pe mpi 16
#$ -S /bin/bash

set -e
set -u
set -o pipefail

module load Bowtie2/v2.3.4.3
module load samtools/v1.10

REF=../References/Smar_GF04_DeNovo.NoDups.fasta

SAMPLE=${PWD##*/}
MATE1=$(ls ../../../00_data/PolyA_Removal/${SAMPLE}/${SAMPLE}.polyAtrim.rRNAdecon.QC_1.fastq)
MATE2=$(ls ../../../00_data/PolyA_Removal/${SAMPLE}/${SAMPLE}.polyAtrim.rRNAdecon.QC_2.fastq)
NAME=${SAMPLE}_vs_Transcriptome

# no-mixed and no-discordant included as they're used by the Trinity utility script `align_and_estimate_abundance`

bowtie2 -p $NSLOTS --no-unal --no-mixed --no-discordant -x $REF -1 $MATE1 -2 $MATE2 -S ${NAME}.sam

samtools view -@ $NSLOTS -b -o ${NAME}.bam ${NAME}.sam
rm ${NAME}.sam
samtools sort -@ $NSLOTS -o ${NAME}_sorted.bam ${NAME}.bam
samtools index ${NAME}_sorted.bam ${NAME}_sorted.bai
